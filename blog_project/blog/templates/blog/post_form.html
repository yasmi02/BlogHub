{% extends 'base.html' %}

{% block title %}{{ title }} - BlogHub{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card shadow-lg" style="background: white; padding: 40px; border-radius: 25px;">
            <h2 class="mb-4">
                <i class="bi bi-pencil-square"></i> {{ title }}
            </h2>

            <form method="post" enctype="multipart/form-data" id="post-form">
                {% csrf_token %}

                <!-- TITLE -->
                <div class="mb-4">
                    <label class="form-label fw-bold fs-5">
                        <i class="bi bi-fonts"></i> Title
                    </label>
                    <input type="text" name="title" class="form-control form-control-lg"
                           placeholder="Enter your post title"
                           value="{% if post %}{{ post.title }}{% endif %}"
                           style="border: 2px solid #ffc2d4; border-radius: 10px; padding: 15px;" required>
                </div>

                <!-- CONTENT WITH TOOLBAR -->
                <div class="mb-4">
                    <label class="form-label fw-bold fs-5">
                        <i class="bi bi-text-paragraph"></i> Write Your Post
                    </label>

                    <!-- Formatting Buttons -->
                    <div style="background: #fff9fb; padding: 15px; border: 2px solid #ffc2d4; border-radius: 10px 10px 0 0; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" onclick="formatDoc('bold')" class="btn btn-sm btn-outline-secondary" title="Bold">
                            <strong>B</strong>
                        </button>
                        <button type="button" onclick="formatDoc('italic')" class="btn btn-sm btn-outline-secondary" title="Italic">
                            <em>I</em>
                        </button>
                        <button type="button" onclick="formatDoc('underline')" class="btn btn-sm btn-outline-secondary" title="Underline">
                            <u>U</u>
                        </button>
                        <button type="button" onclick="formatDoc('strikeThrough')" class="btn btn-sm btn-outline-secondary" title="Strike">
                            <s>S</s>
                        </button>
                        <span style="border-left: 2px solid #ddd; height: 30px;"></span>
                        <button type="button" onclick="makeHeading('h2')" class="btn btn-sm btn-outline-secondary" title="Heading 2">
                            H2
                        </button>
                        <button type="button" onclick="makeHeading('h3')" class="btn btn-sm btn-outline-secondary" title="Heading 3">
                            H3
                        </button>
                        <span style="border-left: 2px solid #ddd; height: 30px;"></span>
                        <button type="button" onclick="formatDoc('insertUnorderedList')" class="btn btn-sm btn-outline-secondary" title="Bullet List">
                            â€¢ List
                        </button>
                        <button type="button" onclick="formatDoc('insertOrderedList')" class="btn btn-sm btn-outline-secondary" title="Number List">
                            1. List
                        </button>
                        <span style="border-left: 2px solid #ddd; height: 30px;"></span>
                        <button type="button" onclick="addLink()" class="btn btn-sm btn-outline-secondary" title="Add Link">
                            ðŸ”— Link
                        </button>
                        <button type="button" onclick="document.getElementById('image-insert-input').click()" class="btn btn-sm btn-outline-primary" title="Insert Image">
                            ðŸ“· Add Photo
                        </button>
                        <button type="button" onclick="formatDoc('removeFormat')" class="btn btn-sm btn-outline-danger" title="Clear Format">
                            âœ– Clear
                        </button>
                    </div>

                    <!-- Hidden file input for inserting images -->
                    <input type="file" id="image-insert-input" accept="image/*" style="display: none;" onchange="insertImage(this)">

                    <!-- WRITING AREA - BIG BOX -->
                    <div id="editor" contenteditable="true"
                         style="border: 2px solid #ffc2d4;
                                border-top: none;
                                border-radius: 0 0 10px 10px;
                                padding: 25px;
                                min-height: 500px;
                                max-height: 700px;
                                overflow-y: auto;
                                font-size: 18px;
                                line-height: 1.8;
                                background: white;
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">{% if post %}{{ post.content|safe }}{% endif %}</div>

                    <textarea name="content" id="hidden-content" style="display: none;"></textarea>

                    <small class="text-muted d-block mt-2">
                        ðŸ’¡ Click "ðŸ“· Add Photo" button to insert images anywhere in your post!
                    </small>
                </div>

                <!-- COVER IMAGE -->
                <div class="mb-4">
                    <label class="form-label fw-bold fs-5">
                        <i class="bi bi-image"></i> Cover Image (Optional)
                    </label>
                    <input type="file" name="image" class="form-control" accept="image/*"
                           style="border: 2px solid #ffc2d4; border-radius: 10px; padding: 15px;">
                    {% if post and post.image %}
                    <div class="mt-3">
                        <p class="text-muted mb-2">Current cover image:</p>
                        <img src="{{ post.image.url }}" alt="Current" style="max-width: 300px; border-radius: 10px;">
                    </div>
                    {% endif %}
                </div>

                <!-- TAGS -->
                <div class="mb-4">
                    <label class="form-label fw-bold fs-5">
                        <i class="bi bi-tags"></i> Tags
                    </label>
                    <input type="text" name="tags" class="form-control"
                           placeholder="#Fashion, Beauty, Lifestyle"
                           value="{% if post %}{{ post.tags.all|join:', ' }}{% endif %}"
                           style="border: 2px solid #ffc2d4; border-radius: 10px; padding: 15px;">
                    <small class="text-muted">Separate with commas</small>
                </div>

                <!-- SUBMIT BUTTONS -->
                <div class="d-flex gap-3">
                    <button type="submit" class="btn btn-primary btn-lg" style="padding: 15px 40px;">
                        <i class="bi bi-send"></i> {% if post %}Update{% else %}Publish{% endif %} Post
                    </button>
                    <a href="{% if post %}{% url 'post_detail' post.slug %}{% else %}{% url 'home' %}{% endif %}"
                       class="btn btn-outline-secondary btn-lg">
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function formatDoc(cmd) {
    document.execCommand(cmd, false, null);
    document.getElementById('editor').focus();
}

function makeHeading(tag) {
    document.execCommand('formatBlock', false, tag);
    document.getElementById('editor').focus();
}

function addLink() {
    var url = prompt('Enter URL:');
    if (url) {
        document.execCommand('createLink', false, url);
    }
    document.getElementById('editor').focus();
}

function insertImage(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            // Create image element
            var img = document.createElement('img');
            img.src = e.target.result;
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.style.borderRadius = '10px';
            img.style.margin = '20px 0';
            img.style.display = 'block';

            // Insert image at cursor position
            var editor = document.getElementById('editor');
            editor.focus();

            // Get selection
            var sel = window.getSelection();
            if (sel.getRangeAt && sel.rangeCount) {
                var range = sel.getRangeAt(0);
                range.deleteContents();
                range.insertNode(img);

                // Move cursor after image
                range.setStartAfter(img);
                range.setEndAfter(img);
                sel.removeAllRanges();
                sel.addRange(range);

                // Add a paragraph after image for easy typing
                var p = document.createElement('p');
                p.innerHTML = '<br>';
                range.insertNode(p);
            } else {
                // Fallback: append at end
                editor.appendChild(img);
                var p = document.createElement('p');
                p.innerHTML = '<br>';
                editor.appendChild(p);
            }

            editor.focus();
        };
        reader.readAsDataURL(input.files[0]);

        // Reset input so same file can be selected again
        input.value = '';
    }
}

document.getElementById('post-form').onsubmit = function(e) {
    var content = document.getElementById('editor').innerHTML;
    document.getElementById('hidden-content').value = content;

    if (document.getElementById('editor').innerText.trim() === '') {
        alert('Please write something in your post!');
        e.preventDefault();
        return false;
    }
};

// Placeholder
var editor = document.getElementById('editor');
if (editor.innerHTML.trim() === '') {
    editor.innerHTML = '<p style="color: #999;">Click here and start writing your amazing post... âœ¨</p>';
}
editor.addEventListener('focus', function() {
    if (this.innerHTML.includes('Click here and start writing')) {
        this.innerHTML = '';
    }
});

// Prevent dropping files directly (to avoid issues)
editor.addEventListener('drop', function(e) {
    e.preventDefault();
    alert('Please use the "ðŸ“· Add Photo" button to insert images!');
});
editor.addEventListener('dragover', function(e) {
    e.preventDefault();
});
</script>
{% endblock %}